---
title: "SI"
bibliography: 
  - references.bib
  - references_other.yaml
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
  - BoldFont=Roboto-Bold.ttf
  - ItalicFont=Roboto-Italic.ttf
  - BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: none # Use pandoc default, otherwise csl can't be used for reference formatting
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "journal-of-plant-research.csl"]
    includes:
      in_header: journal-of-plant-research-si.sty
header-includes: 
  \usepackage{float}
  \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
editor_options: 
  markdown: 
    wrap: sentence
  chunk_output_type: console
---

```{r si-setup, include = FALSE, cache = FALSE, purl=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide", cache = FALSE)
# if running interactively, source packages and functions first
# source("R/packages.R")
# source("R/functions.R")
```

```{r captions}
# Source captions from MS
# so that caption numbers are numbered in order of appearance in MS

# Run inline code when purling
options(knitr.purl.inline = TRUE)

# Make a temporary file to write out just inline R code from the SI Rmd
temp_file <- tempfile()

# Generate R script including inline R code from the SI Rmd
# (add `purl = FALSE` to code chunks in SI Rmd so those don't run)
knitr::purl(here::here("ms/manuscript.Rmd"), output = temp_file)

# Trim this R script down to only functions that define figure and table captions
read_lines(temp_file) %>%
  magrittr::extract(
    str_detect(., "^figure\\(|^table\\(|^s_figure\\(|^s_table\\(|^figure_num\\(|^table_num\\(|^s_figure_num\\(|^s_table_num\\(")
  ) %>%
  unique %>%
  write_lines(temp_file)

# Source the code. This will load the caption functions in the right order.
source(temp_file)

# Delete the temporary file
fs::file_delete(temp_file)
```

```{r si-load-data, cache = FALSE}
tar_load(filmy_dt_chamber)
tar_load(filmy_dt)
tar_load(filmy_habit)
tar_load(rel_water_indiv)
tar_load(rel_water_species_means)
tar_load(filmy_phy)
tar_load(filmy_habit)
tar_load(range_comparison)
tar_load(light_data_all)
tar_load(light_models)
tar_load(filmy_lc_model_params)
tar_load(filmy_lc_model_fitted_data)
```

```{r si-load-functions, cache = FALSE}
# Define functions specific to this file
plot_chamber_rh <- function (data, time_limits) {
  ggplot(data, aes(x = date_time, y = 0.01*rh)) +
    geom_line() +
    scale_x_datetime(limits = time_limits) +
    scale_y_continuous(label = label_percent(accuracy = 1)) +
    labs(y = "Relative humidity") +
    theme(
      legend.position = "none",
      axis.title.x = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank())
}

plot_chamber_temp <- function (data, time_limits) {
  ggplot(data, aes(x = date_time, y = temp)) +
    geom_line() +
    scale_x_datetime(limits = time_limits) +
    scale_y_continuous(label = label_number(suffix = "\u00b0C", accuracy = 1)) +
    labs(y = "Temperature") +
    theme(
      legend.position = "none",
      axis.title.x = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank())
}

plot_sporo_chamber_time <- function (data, time_limits) {
    ggplot(data, aes(x = species, ymin = pre, ymax = post, y = post, group = species_duration, linetype = dry_time)) +
    geom_linerange(position = position_dodge(0.5)) +
    geom_point(position = position_dodge(0.5)) +
    scale_y_datetime(limits = time_limits) +
    scale_linetype_manual(values = c("15" = "solid", "2" = "solid")) +
    coord_flip() +
    labs(x = "Species") +
    theme(
      axis.title.x = element_blank(),
      legend.position = "none"
    )
}

plot_sporo_chamber <- function (sporo_times_data, filmy_dt_chamber_data, salt_select, k_select) {
  
  # Get mean times of each cluster of DT test samples for the selected drying salt
  sporo_clusters <- cluster_sporo_times(sporo_times_data, salt_select, k_select)
  
  # Calculate time range for the clustered data
  sporo_time_range <- c(min = min(sporo_clusters$pre), max = max(sporo_clusters$post))
  
  # Subset DT chamber data
  sporo_chamber_data <-
    filmy_dt_chamber_data %>% 
    filter(date_time >= sporo_time_range[["min"]], date_time <= sporo_time_range[["max"]], salt == salt_select)
  
  # RH plot
  rh_plot <- plot_chamber_rh(sporo_chamber_data, sporo_time_range)
  
  # Temp plot
  temp_plot <- plot_chamber_temp(sporo_chamber_data, sporo_time_range)
  
  # Dry times plot
  time_plot <- plot_sporo_chamber_time(sporo_clusters, sporo_time_range)
  
  # Combine plots
  rh_plot + temp_plot + time_plot + plot_layout(ncol = 1)
}

# Define function to plot facetted light curve
make_facet_lc_plot <- function(light_data, lc_model_fitted_data, lc_model_params) {
  
  cbPalette <- c(grey = "#999999", gold = "#E69F00", skyblue = "#56B4E9", 
               green = "#009E73", yellow = "#F0E442", blue = "#0072B2", 
               red = "#D55E00", purple = "#CC79A7")
  
  ggplot(mapping = aes(x = par)) +
    geom_point(
      data = light_data, 
      aes(y = etr, alpha = outlier)) +
    geom_line(
      data = lc_model_fitted_data, 
      aes(y = etr_fit)) +
    geom_hline(
      data = lc_model_params, 
      aes(yintercept = etr), color = cbPalette[["blue"]]) +
    geom_vline(
      data = lc_model_params, 
      aes(xintercept = par), color = cbPalette[["red"]]) +
    scale_alpha_manual(values = c("TRUE" = 0.2, "FALSE" = 1.0)) +
    labs(
      y = "ETR<sub>max</sub>", 
      x = "PPFD (µmol·m<sup>-2</sup>·s<sup>-1</sup>)", 
      alpha = "Outlier") +
    theme(
      axis.title.x = element_markdown(),
      axis.title.y = element_markdown(),
      strip.text = element_markdown(),
      plot.title = element_markdown(),
      legend.position = "none"
    ) +
    facet_wrap_paginate(
      vars(str_abbrev_sp_pretty(species), light_id), 
      ncol = 4, nrow = 6, page = 1,
      scales = "free", labeller = label_value_2)
}

#' Cluster times from a sporophyte desiccation tolerance (DT) test
#' 
#' Calculates mean pre- and post-DT test times by species and duration of DT test
#' (2 or 15 days), also adds a `species_duration` column to the output for plotting.
#'
#' @param sporo_time_data Dataframe with DT test data for sporophytes
#' @param salt_select Name of salt to subset data
#' @param k_select Number of groups to cluster. For example, if the DT
#' test was done in 3 groups, `k_select` = 3.
#'
#' @return Dataframe
cluster_sporo_times <- function (sporo_time_data, salt_select, k_select) {
  
  sporo_2d_clusters <- 
    sporo_time_data %>%
    filter(salt == salt_select, dry_time == "2") %>%
    add_clusters("pre", k_select) %>% # choose K by inspecting raw data first
    group_by(species, cluster, salt, dry_time) %>%
    summarize(pre = mean(pre), post = mean(post), n = n(), .groups = "drop") # %>%
    # select(-cluster)
  
  sporo_15d_clusters <- 
    sporo_time_data %>%
    filter(salt == salt_select, dry_time == "15") %>%
    add_clusters("pre", k_select) %>%
    group_by(species, cluster, salt, dry_time) %>%
    summarize(pre = mean(pre), post = mean(post), n = n(), .groups = "drop") # %>%
    # select(-cluster)
  
  bind_rows(sporo_2d_clusters, sporo_15d_clusters) %>%
    mutate(species_duration = paste(species, dry_time))
  
}
```

```{r si-plot-setup}
# JPR requirements:
# Figures should be 39 mm, 84 mm, 129 mm, or 174 mm wide and not higher than 234 mm
# In inches, widths: 1.53, 3.31, 5.08, 6.85; height: 9.21

# Set overall theme, saving default theme
default_theme <- theme_set(
  theme_bw(base_size = 10) +
    theme(
      panel.grid.minor = element_blank()
    ))

# Define color-blind palette
cbPalette <- c(grey = "#999999", gold = "#E69F00", skyblue = "#56B4E9", 
               green = "#009E73", yellow = "#F0E442", blue = "#0072B2", 
               red = "#D55E00", purple = "#CC79A7")

# Set colors for growth habit, generation
habit_colors <- c(
  "Terrestrial" = cbPalette[["red"]], 
  "Saxicolous" = cbPalette[["gold"]], 
  "Low_Epiphyte" = cbPalette[["green"]],
  "High_Epiphyte" = cbPalette[["blue"]])
```

```{r full-phylo, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Copy phylogeny and species means data so they
# can be manipulated for this plot
phy <- filmy_phy
habit <- filmy_habit

# Set colors for growth habit, generation
habit_colors <- c(
  "Terrestrial" = cbPalette[["red"]], 
  "Saxicolous" = cbPalette[["gold"]], 
  "Low_Epiphyte" = cbPalette[["green"]],
  "High_Epiphyte" = cbPalette[["blue"]])

generation_colors <- c(
  "gametophyte" = "grey70",
  "sporophyte" = "grey30"
)

# Filter growth habit data to only species in phylogeny
habit <-
  habit %>%
  filter(species %in% phy$tip.label)

# Convert underscores to spaces
# phy$tip.label <- str_replace_all(phy$tip.label, "_", "~")

# Make a tibble of bootstrap values to map onto tree
# - needs one column with "node", the other can be named as we like
# - hard-code node ID: internal nodes start after tip nodes,
#   and phy$node.label is in the same order as internal nodes
bs_tibble <- tibble(
  node=1:Nnode(phy) + Ntip(phy), 
  # Don't print BS < 50%
  bootstrap = ifelse(phy$node.label < 50, "", phy$node.label))

# Join growth habit and BS data to ggtree object
ggtree(phy) %<+% filmy_habit %<+% bs_tibble +
  geom_text(aes(label=bootstrap), hjust=-.25, size = 3, color = "grey30") +
  geom_tippoint(aes(color = habit), position = position_nudge(x = 0, y = 0), size = 4) +
  # Add species labels
  geom_tiplab(
    # getting species names into italics is painful....
    # need to use plotmath() parsing.
    # to print a space, use `~`
    # e.g., `italic("Hymenophyllum~polyanthos")`
    aes(label=paste0('italic(', str_replace_all(label, "_", "~"), ')')), 
    parse = TRUE,
    hjust = -0.02) +
  # There is no way modify the text in geom_treescale (to add units), so make the
  # text disappear by setting fontsize = 0
  geom_treescale(y = 20, x = 0, width = 40, fontsize = 0) +
  # Manually place custom label above scale bar
  annotate("text", x = 20, y = 20, label = "40 my", size = 3, vjust = -1) +
  # Scale colors by growth habit
  scale_color_manual(values = habit_colors, labels = pretty_text) +
  labs(color = "Growth habit") +
  # Need to remove clip so that species names print properly
  coord_cartesian(clip = "off") +
  theme(
  plot.margin = margin(t = 0, r = 2.2, b = 0, l = 0, unit = "in"),
  legend.position = "bottom"
)
```

**`r s_figure("tree")`**. Maximum likelihood ultrametric phylogenetic tree including all Moorean filmy fern species.
Tree obtained by extracting Hymenophyllaceae from the tree of Nitta et al. (2016) with the extract.clade function of the ape package in R (Paradis et al., 2004).
Bootstrap support values >50% shown at nodes.
Growth habit indicated by colored dots. 
*Crepidomanes bipunctatum* and *C. humile* were observed growing as both epiphytes and saxicoles, but are shown as epiphytes to distinguish them from exclusively saxicolous species.

\newpage

```{r sporophyte-dt-2013-prep}
# Extract pre- and post-DT treatment times for sporophytes
sporo_times <-
  filmy_dt %>%
  filter(generation == "sporophyte") %>%
  select(species:dataset, contains("time_")) %>%
  pivot_longer(names_to = "condition", values_to = "date_time", contains("time_")) %>%
  filter(!is.na(date_time)) %>%
  mutate(condition = str_remove_all(condition, "time_") %>%
           # Consider first recovery measurement (at 30 min) to be "post-DT treatment"
           str_replace_all("30min", "post")) %>%
  filter(condition %in% c("pre", "post")) %>%
  add_count(species, salt, dry_time, individual, dataset) %>%
  filter(n > 1) %>%
  select(-n) %>%
  pivot_wider(names_from = "condition", values_from = "date_time")
```

```{r sporophyte-dt-2013-LiCl, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Get mean times of each cluster of DT test samples for the selected drying salt
sporo_clusters_2013 <- cluster_sporo_times(filter(sporo_times, str_detect(dataset, "2013")), "LiCl", 3)
sporo_clusters_2014 <- cluster_sporo_times(filter(sporo_times, str_detect(dataset, "2014")), "LiCl", 1)

sporo_clusters <- bind_rows(sporo_clusters_2013, sporo_clusters_2014)

# Calculate time range for the clustered data
sporo_time_range_2013 <- c(min = min(sporo_clusters_2013$pre), max = max(sporo_clusters_2013$post))
sporo_time_range_2014 <- c(min = min(sporo_clusters_2014$pre), max = max(sporo_clusters_2014$post))

# Subset DT chamber data
licl_chamber_data_2013 <-
  filter(filmy_dt_chamber, 
    date_time >= sporo_time_range_2013[["min"]], 
    date_time <= sporo_time_range_2013[["max"]], 
    salt == "LiCl")
licl_chamber_data_2014 <- 
  filter(filmy_dt_chamber, 
    date_time >= sporo_time_range_2014[["min"]], 
    date_time <= sporo_time_range_2014[["max"]], 
    salt == "LiCl") %>%
  # There are two sets of times: 2014-06-17 to 2014-07-02, and 2014-07-06 to 2014-07-08
  # Add a group for these so ggplot doesn't connect lines betweeen them
  mutate(
    day = yday(date_time),
    group = ifelse(day < 185, "a", "b"))

licl_chamber_data <- bind_rows(licl_chamber_data_2013, licl_chamber_data_2014)
licl_temp_range <- c(min(licl_chamber_data$temp), max(licl_chamber_data$temp))
licl_rh_range <- c(min(licl_chamber_data$rh), max(licl_chamber_data$rh))*0.01

# RH plot
rh_plot_2013 <- plot_chamber_rh(licl_chamber_data_2013, sporo_time_range_2013) +
  scale_y_continuous(limits = licl_rh_range, label = label_percent(accuracy = 1))

rh_plot_2014 <- ggplot(licl_chamber_data_2014, aes(x = date_time, y = 0.01*rh, group = group)) +
  geom_line() +
  scale_x_datetime(limits = sporo_time_range_2014) +
  blank_x_theme() +
  blank_y_theme() +
  theme(legend.position = "none")

# Temp plot
temp_plot_2013 <- plot_chamber_temp(licl_chamber_data_2013, sporo_time_range_2013) +
  scale_y_continuous(limits = licl_temp_range, label = label_number(suffix = "\u00b0C", accuracy = 1))

temp_plot_2014 <- ggplot(licl_chamber_data_2014, aes(x = date_time, y = temp, group = group)) +
  geom_line() +
  scale_x_datetime(limits = sporo_time_range_2014) +
  blank_x_theme() +
  blank_y_theme() +
  theme(legend.position = "none")

# Dry times plot
time_plot_2013 <- plot_sporo_chamber_time(sporo_clusters, sporo_time_range_2013) +
  labs(y = "2013") +
  theme(axis.title.x = element_text()) 
time_plot_2014 <- plot_sporo_chamber_time(sporo_clusters, sporo_time_range_2014)  +
  labs(y = "2014")  +
  theme(axis.title.x = element_text()) +
  blank_y_theme()

# Combine plots
temp_plot_2013 + temp_plot_2014 + 
  rh_plot_2013 + rh_plot_2014 + 
  time_plot_2013 + time_plot_2014 + 
  plot_layout(ncol = 2)

# ggsave(here::here("results/S2_fig.png"))
```

**`r s_figure("chamber-s")`**. Conditions inside desiccation chamber and duration of desiccation treatment for sporophytes at most intense desiccation level. LiCl was used to maintain constant humidity at \circa{ }18%.

\newpage

```{r gametophyte-dt-2013, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Calculate mean start/end times for gametophyte DT groups
gameto_mean_times <-
  filmy_dt %>%
  filter(generation == "gametophyte") %>%
  select(individual, contains("time_")) %>%
  pivot_longer(names_to = "condition", values_to = "date_time", -individual) %>%
  filter(!is.na(date_time)) %>%
  mutate(condition = str_remove_all(condition, "time_") %>%
           str_replace_all("30min", "post")) %>%
  filter(condition %in% c("pre", "post")) %>%
  add_count(individual) %>%
  filter(n > 1) %>%
  select(-n) %>%
  pivot_wider(names_from = "condition", values_from = "date_time") %>%
  # Cluster starts times into groups (here, I know there are 10 groups)
  add_clusters("pre", 10) %>%
  mutate(cluster = as.factor(cluster)) %>%
  group_by(cluster) %>%
  summarize(pre = mean(pre), post = mean(post), n = n(), .groups = "drop")
  
gameto_time_limits <- c(min = min(gameto_mean_times$pre), max = max(gameto_mean_times$post))

# DT start/end times plot
dt_times_gameto_2013_plot <- ggplot(
  gameto_mean_times, 
  aes(x = cluster, ymin = pre, ymax = post, y = post, group = cluster)) +
  geom_linerange(position = position_dodge(0.5)) +
  geom_point(position = position_dodge(0.5)) +
  scale_y_datetime(limits = gameto_time_limits) +
  coord_flip() +
  labs(x = "Group") +
  theme(
    axis.title.x = element_blank()
  )

# Subset DT chamber data
chamber_gameto_2013 <- filmy_dt_chamber %>% filter(generation == "gametophyte", year == "2013")

# RH plot
chamber_gameto_2013_rh_plot <-
  plot_chamber_rh(chamber_gameto_2013, gameto_time_limits)
  
# Temp plot
chamber_gameto_2013_temp_plot <-
  plot_chamber_temp(chamber_gameto_2013, gameto_time_limits)

chamber_gameto_2013_temp_plot + chamber_gameto_2013_rh_plot + dt_times_gameto_2013_plot + plot_layout(ncol = 1)

# ggsave(here::here("results/S1_fig.png"))
```

**`r s_figure("chamber-g")`**. Conditions inside desiccation chamber and duration of desiccation treatment for gametophytes. MgNO~3~ was used to maintain constant humidity at \circa{ }58%. All gametophytes were treated to desiccation for 2 days, except for group 8, which was treated for four days unintentionally

\newpage

```{r range-plot, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Make plot showing range of gametophytes beyond sporophytes
plot_data <-
range_comparison %>%
  left_join(filmy_habit, by = "species") %>%
  mutate(species = fct_reorder(species, sporo_mean_el)) %>%
  mutate(
    gameto_max_el = case_when(
      is.na(gameto_max_el) ~ sporo_max_el,
      sporo_max_el > gameto_max_el ~ sporo_max_el,
      TRUE ~ gameto_max_el
    ),
    gameto_min_el = case_when(
      is.na(gameto_min_el) ~ sporo_min_el,
      sporo_min_el < gameto_min_el ~ sporo_min_el,
      TRUE ~ gameto_min_el
    )
  )
  
ggplot(plot_data, aes(y = species)) +
  # Gameto range as line for those with different min/max elevation
  geom_linerange(aes(xmin = gameto_min_el, xmax = gameto_max_el), color = "grey10") +
  # Gameto range as point for those with single elevation, if different from sporo elevation
  geom_point(
    data = filter(
      plot_data,
      gameto_min_el == gameto_max_el, gameto_min_el != sporo_min_el, gameto_max_el != sporo_max_el),
    aes(x = sporo_mean_el), 
    fill = "grey10"
  ) +
  # Sporo range as fat line for those with different min/max elevation
  geom_linerange(
    data = filter(plot_data, sporo_min_el != sporo_max_el),
    aes(xmin = sporo_min_el, xmax = sporo_max_el, color = habit), 
    size = 3, fill = "grey10") +
  # Sporo range as point for those with single elevation
  geom_point(
    data = filter(plot_data, sporo_min_el == sporo_max_el),
    aes(x = sporo_mean_el, color = habit)
  ) +
  # Diamond for gameto min el below sporo min el
  geom_point(
    data = filter(range_comparison, gameto_min_el < sporo_min_el), 
    aes(x = gameto_min_el),
    shape = 23, fill = "grey10") +
  # Diamond for gameto min el above sporo max el
  geom_point(
    data = filter(range_comparison, gameto_max_el > sporo_max_el),
    aes(x = gameto_max_el),
    shape = 23, fill = "grey10") +
  scale_color_manual(values = habit_colors, labels = pretty_text) +
  scale_y_discrete(labels = pretty_text) +
  labs(x = "Elevation (m)", y = "Species", color = "Growth habit") +
  theme(
    legend.position = "bottom",
    axis.text.y = element_text(face = "italic")
  )
```

**`r s_figure("range")`**. Elevational range (m) of sporophytes and gametophytes of filmy ferns on Moorea, French Polynesia. Elevational range width shown with colored bars (sporophytes) or black lines (gametophytes). Species observed only at a single elevation (not a range) shown with points. Extent of range of gametophytes beyond sporophytes shown with black diamonds. Color indicates growth habit. Presence of gametophytes assumed at sites where sporophytes were observed, even if gametophytes of that species were not collected from that site.

```{r water-content-prep}
# Define color-blind palette
cbPalette <- c(grey = "#999999", gold = "#E69F00", skyblue = "#56B4E9", 
               green = "#009E73", yellow = "#F0E442", blue = "#0072B2", 
               red = "#D55E00", purple = "#CC79A7")

# Set colors, shapes for desiccation intensity
salt_cols <- c(
  "NaCl" = cbPalette[["blue"]], 
  "MgNO3" = cbPalette[["yellow"]], 
  "LiCl" = cbPalette[["red"]], 
  "Control" = "white")

salt_shapes <- c(
  "NaCl" = 21, # circle
  "MgNO3" = 24, # triangle
  "LiCl" = 23, # diamond
  "Control" = 22 # square
  )
```

```{r sporo-dt-controls, fig.height = 8, fig.width = 7, fig.cap = ""}
# Plot sporophyte DT controls

# Set dodge spacing, colors
pd <- position_dodge(.7)

# Prepare data for plotting
dt_control_plot_data <-
  # Start with DT data
  filmy_dt %>%
  filter(salt == "Control") %>%
  # Filter out individuals with low pre-treatment yields
  filter(!is.na(yield_pre), yield_pre > 400) %>%
  # Calculate recovery by individual
  verify(yield_pre > 0) %>%
  assert(not_na, yield_pre) %>%
  select(species, salt, dry_time, individual, dataset, generation, contains("yield")) %>%
  select(-yield_72hr, -contains("yield_dry")) %>%
  pivot_longer(names_to = "rec_time", values_to = "yield_recover", matches("30|24|48")) %>%
  mutate(
    rec_time = str_remove_all(rec_time, "yield_"),
    recovery = yield_recover / yield_pre) %>%
  select(-contains("yield")) %>%
  # Calculate mean recovery by species and dataset
  mutate(rec_time = factor(rec_time, levels = c("30min", "24hr", "48hr"))) %>%
  group_by(species, salt, dry_time, rec_time, generation, dataset) %>%
  summarize(
    recovery_mean = mean(recovery, na.rm = TRUE),
    sd = sd(recovery, na.rm = TRUE),
    n = n(),
    .groups = "drop") %>%
  rename(recovery = recovery_mean) %>%
  # Add growth habit data
  left_join(filmy_habit, by = "species") %>%
  assert(not_na, habit) %>%
  mutate(
    habit = str_replace_all(habit, "_", " ") %>% 
      str_to_sentence() %>%
      factor(levels = c("Terrestrial", "Saxicolous", "Low epiphyte", "High epiphyte"))) %>%
  # Add dataset year
  mutate(year = str_split(dataset, "_") %>% map_chr(1)) %>%
  # Abbreviate species names to "G. species"
  mutate(
    species = str_replace_all(species, "[a-z]+_", ". "),
    species = glue("*{species}*")) %>%
  # Add year to species names with multiple datasets
  add_count(species, name = "n_species") %>%
  mutate(species = ifelse(n_species > 6 & generation == "sporophyte", paste(species, year), species)) %>%
  select(-n_species) %>%
  # Only keep rows with recovery
  filter(!is.na(recovery))

# Make plot: sporophyte controls
a <-
  dt_control_plot_data %>% 
  filter(generation == "sporophyte") %>%
  ggplot(aes(x = rec_time, y = recovery, shape = dry_time, fill = salt)) +
  geom_point(position = pd, size = 1.5, fill = "white") +
  geom_errorbar(
    aes(ymin = recovery - sd, ymax = recovery + sd), 
    colour = "grey50", width = 0, 
    position = pd) +
  facet_wrap(vars(habit, species)) +
  scale_shape_manual(name = "Desiccation Time",
                     values = c(24, 21),
                     breaks = c("15", "2"),
                     labels = c("15 days", "2 days")) +
  scale_y_continuous(label = label_percent(accuracy = 1)) +
  scale_x_discrete(limits = c("30min","24hr","48hr"),
                   labels = c("0.5", "24", "48")) +
  xlab("Recovery Time (hr)") +
  ylab("Recovery (%)") +
  theme_bw() +
  legend_theme +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank(), 
    panel.grid.major.x = element_blank(),
    strip.text = element_markdown(),
    axis.title.x = element_blank()
  )


# Make plot: gametophyte controls
b <-
  dt_control_plot_data %>% 
  filter(generation == "gametophyte") %>% 
  ggplot(aes(x = rec_time, y = recovery, shape = dry_time, fill = salt)) +
  geom_point(position = pd, size = 1.5, fill = "white") +
  geom_errorbar(
    aes(ymin = recovery - sd, ymax = recovery + sd), 
    colour = "grey50", width = 0, 
    position = pd) +
  facet_wrap(vars(habit, species)) +
  scale_shape_manual(name = "Desiccation Time",
                        values = c(24, 21),
                        breaks = c("15", "2"),
                        labels = c("15 days", "2 days")) +
  scale_y_continuous(label = label_percent(accuracy = 1)) +
  scale_x_discrete(limits = c("30min","24hr","48hr"),
                   labels = c("0.5", "24", "48")) +
  xlab("Recovery Time (hr)") +
  ylab("Recovery (%)") +
  theme_bw() +
  theme(
        panel.grid.minor = element_blank(), 
        panel.grid.major.x = element_blank(),
        strip.text = element_markdown()
) +
  # Use guides to make the legend go away
  # otherwise it will be duplicated by patchwork
  # https://github.com/thomasp85/patchwork/issues/170#issuecomment-641310103
  guides(shape = "none")

a + b + plot_layout(guides = "collect", ncol = 1, heights = c(85, 15)) + plot_annotation(tag_levels = "a") &
  theme(legend.position='bottom')
```

**`r s_figure("dt-control")`**. Recovery of controls (samples kept on moist tissues) for desiccation tolerance test of filmy fern sporophytes (**a**) and gametophytes (**b**) from Moorea, French Polynesia. Recovery was measured by comparing maximum photochemical yield of photosystem II before desiccation treatment with values at 30 min, 24 hr, and 48 hr following desiccation treatment (see Methods). Recovery was not measured for all combinations of species and desiccation treatments; missing points indicate data not collected (not recovery of 0%). Gametophytes only included a single individual per species thus lack error bars.

\newpage

```{r water-content-desiccated, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Plot relative water content in desiccated state for all species
rel_water_species_means_desic <<-
rel_water_species_means %>%
  filter(rec_time == "desiccated") %>%
  select(-rec_time)

# Set dodge spacing, colors
pd <- position_dodge(.7)

ggplot(rel_water_species_means_desic, aes(x = rel_water, y = species, group = salt)) +
  geom_errorbar(
    aes(xmin = rel_water - sd, xmax = rel_water + sd),
    color = "grey80",
    width = 0.2,
    position=position_dodge(width=0.5)) +
  geom_point(aes(fill = salt, shape = salt), size = 1.25, position=position_dodge(width=0.5)) +
  scale_x_continuous(label = scales::percent) +
  scale_shape_manual(name = "Desiccation Intensity",
                     values = salt_shapes,
                     breaks = c("NaCl", "MgNO3",  "LiCl", "Control"),
                     labels = c("-38 MPa", "-86 MPa", "-282 Mpa", "Control")) + 
  scale_fill_manual(name = "Desiccation Intensity",
                    values = salt_cols, 
                    breaks = c("NaCl", "MgNO3",  "LiCl", "Control"),
                    labels = c("-38 MPa", "-86 MPa", "-282 Mpa", "Control")) +
  labs(
    x = "Relative Water Content",
    y = "Species",
    color = "Desiccation\nintensity") +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = "bottom"
  ) +
  facet_grid(vars(dry_time), labeller = as_labeller(c(`2` = "2 days", `15` = "15 days")))

# ggsave(here::here("results/S_fig_water_content_desic.pdf"))
```

**`r s_figure("water-all")`**. Relative water content (RWC) of sporophytes after desiccation by duration of desiccation treatment (2 or 15 days). RWC was not measured for all combinations of species and desiccation treatments; missing points indicate data not collected (not RWC of zero).

\newpage

```{r water-content-full, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Plot only species with weights recorded during recovery
species_with_rec <-
  rel_water_species_means %>%
  filter(rec_time %in% c("30min", "24hr", "48hr")) %>%
  pull(species) %>%
  unique()

rel_water_species_means_with_rec <-
  rel_water_species_means %>%
  filter(species %in% species_with_rec)

pd <- position_dodge(.5)

# Define color-blind palette
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# Set colors for desiccation intensity
salt_cols <- c("NaCl" = cbPalette[7], "MgNO3" = cbPalette[5], "LiCl" = cbPalette[6], "Control" = "white")

ggplot(rel_water_species_means_with_rec, aes(x = rec_time, y = rel_water, group = interaction(dry_time, salt))) +
  geom_errorbar(
    aes(ymin = rel_water - sd, ymax = rel_water + sd),
    color = "grey50",
    width = 0,
    position = pd) +
  geom_line(position = pd, aes(linetype = dry_time), color = "grey30") +
  geom_point(aes(shape = salt, fill = salt), position = pd) +
  scale_linetype_manual(name = "Desiccation Time",
                        values = c("solid", "dashed"),
                        breaks = c("15", "2"),
                        labels = c("15 days", "2 days")) +
  scale_shape_manual(name = "Desiccation Intensity",
                     values = salt_shapes,
                     breaks = c("NaCl", "MgNO3",  "LiCl", "Control"),
                     labels = c("-38 MPa", "-86 MPa", "-282 Mpa", "Control")) + 
  scale_fill_manual(name = "Desiccation Intensity",
                    values = salt_cols, 
                    breaks = c("NaCl", "MgNO3",  "LiCl", "Control"),
                    labels = c("-38 MPa", "-86 MPa", "-282 Mpa", "Control")) +
  scale_y_continuous(label = scales::percent) +
  facet_wrap(vars(species)) +
  labs(x = "Condition",
       y = "Relative water content") +
  theme_bw() +
  theme(
    panel.grid.major.x = element_blank(),
    legend.position = "bottom",
    legend.box="vertical", 
    legend.margin=margin()
  )
  
# ggsave(here::here("results/S_fig_water_content_full.png"))
```

**`r s_figure("water-s")`**. Relative water content (RWC) of sporophytes during desiccation tolerance test. RWC was not measured for all combinations of species and desiccation treatments; only species with complete data shown.

\newpage

```{r sporo-lab-light-curves, fig.height = 9.5, fig.width = 7, fig.cap = ""}
### Make full sets of light curve plots ###
# - sporos in lab
lc_plots_sporo_lab <- make_facet_lc_plot(
  light_data = light_data_all %>% filter(generation == "sporophyte", condition == "lab"),
  lc_model_fitted_data = filmy_lc_model_fitted_data %>% filter(generation == "sporophyte", condition == "lab"),
  lc_model_params = filmy_lc_model_params %>% filter(generation == "sporophyte", condition == "lab")
)
# - sporos in field
lc_plots_sporo_field <- make_facet_lc_plot(
  light_data = light_data_all %>% filter(generation == "sporophyte", condition == "field"),
  lc_model_fitted_data = filmy_lc_model_fitted_data %>% filter(generation == "sporophyte", condition == "field"),
  lc_model_params = filmy_lc_model_params %>% filter(generation == "sporophyte", condition == "field")
)
# - gametos
lc_plots_gameto <- make_facet_lc_plot(
  light_data = light_data_all %>% filter(generation == "gametophyte"),
  lc_model_fitted_data = filmy_lc_model_fitted_data %>% filter(generation == "gametophyte"),
  lc_model_params = filmy_lc_model_params %>% filter(generation == "gametophyte")
)

### Get the number of pages needed to print each facetted plot ###
n_sporo_lab_lc_pages <- n_pages(lc_plots_sporo_lab)
n_sporo_field_lc_pages <- n_pages(lc_plots_sporo_field)
n_gameto_lc_pages <- n_pages(lc_plots_gameto)

### Print sporos in the lab ###
# first with title "a"
lc_plots_sporo_lab +
labs(title = "**a**") +
facet_wrap_paginate(
    vars(str_abbrev_sp_pretty(species), light_id),
    ncol = 4, nrow = 6, page = 1,
    scales = "free", labeller = label_value_2)

# print the rest
# with title "a (cont.)"
for(i in 2:n_sporo_lab_lc_pages) {
  p <- lc_plots_sporo_lab +
    labs(title = "**a** (cont.)") +
    facet_wrap_paginate(
      vars(str_abbrev_sp_pretty(species), light_id),
      ncol = 4, nrow = 6, page = i,
      scales = "free", labeller = label_value_2)
  print(p)
}

### Print sporos in the field ###
# first with title "b"
lc_plots_sporo_field +
labs(title = "**b**") +
facet_wrap_paginate(
    vars(str_abbrev_sp_pretty(species), light_id),
    ncol = 4, nrow = 6, page = 1,
    scales = "free", labeller = label_value_2)

# print the rest
# with title "b (cont.)"
for(i in 2:n_sporo_field_lc_pages) {
  p <- lc_plots_sporo_field +
    labs(title = "**b** (cont.)") +
    facet_wrap_paginate(
      vars(str_abbrev_sp_pretty(species), light_id),
      ncol = 4, nrow = 6, page = i,
      scales = "free", labeller = label_value_2)
  print(p)
}

### Print the gametos ###
# first with title "c"
lc_plots_gameto +
labs(title = "**c**") +
facet_wrap_paginate(
    vars(str_abbrev_sp_pretty(species), light_id),
    ncol = 4, nrow = 6, page = 1,
    scales = "free", labeller = label_value_2)

# print the rest
# with title "c (cont.)"
for(i in 2:n_gameto_lc_pages) {
  p <- lc_plots_gameto +
    labs(title = "**c** (cont.)") +
    facet_wrap_paginate(
      vars(str_abbrev_sp_pretty(species), light_id),
      ncol = 4, nrow = 6, page = i,
      scales = "free", labeller = label_value_2)
  print(p)
}
```

**`r s_figure("light-curves")`**. Rapid light response curves of filmy ferns from Moorea, French Polynesia. **a**, sporophytes measured in the lab; **b**, sporophytes measured in the field; **c** gametophytes measured in the field (no gametophytes were measured in the lab). Title of each subplot indicates species followed by light curve ID number assigned to each sample. Light curves fit using the equation $y = A(1 - e^{-kx})$, where *y* is relative electron transport rate of photosystem II (ETR), *x* is photosynthetic photon flux density (PPFD), *A* is the asymptote of the curve, and *k* is a slope parameter. Outliers at high PPFD not included in the model indicated in light grey. Blue line indicates maximum modeled relative electron transport rate (ETR~max~). Red line indicates PPFD at 95 % saturation of ETR (PPFD~95%~).
