---
title: ""
bibliography: 
  - references.bib
  - references_other.yaml
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
  - BoldFont=Roboto-Bold.ttf
  - ItalicFont=Roboto-Italic.ttf
  - BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: none # Use pandoc default, otherwise csl can't be used for reference formatting
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "journal-of-plant-research.csl"]
    includes:
      in_header: journal-of-plant-research-si.sty
# https://stackoverflow.com/questions/25849814/rstudio-rmarkdown-both-portrait-and-landscape-layout-in-a-single-pdf
header-includes: 
  \usepackage{float}
  \makeatletter\renewcommand*{\fps@figure}{H}\makeatother
  \usepackage{pdflscape}
  \newcommand{\blandscape}{\begin{landscape}}
  \newcommand{\elandscape}{\end{landscape}}
editor_options: 
  markdown: 
    wrap: sentence
  chunk_output_type: console
---

```{r si-setup, include = FALSE, cache = FALSE, purl=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = "hide", cache = FALSE)
# if running interactively, source packages and functions first
# source("R/packages.R")
# source("R/functions.R")
```

```{r captions}
# Source captions from MS
# so that caption numbers are numbered in order of appearance in MS

# Run inline code when purling
options(knitr.purl.inline = TRUE)

# Make a temporary file to write out just inline R code from the SI Rmd
temp_file <- tempfile()

# Generate R script including inline R code from the SI Rmd
# (add `purl = FALSE` to code chunks in SI Rmd so those don't run)
knitr::purl(here::here("ms/manuscript.Rmd"), output = temp_file)

# Trim this R script down to only functions that define figure and table captions
read_lines(temp_file) %>%
  magrittr::extract(
    str_detect(., "^figure\\(|^table\\(|^s_figure\\(|^s_table\\(|^figure_num\\(|^table_num\\(|^s_figure_num\\(|^s_table_num\\(")
  ) %>%
  unique %>%
  write_lines(temp_file)

# Source the code. This will load the caption functions in the right order.
source(temp_file)

# Delete the temporary file
fs::file_delete(temp_file)
```

```{r si-load-data, cache = FALSE}
tar_load(filmy_dt_chamber)
tar_load(filmy_dt)
tar_load(filmy_habit)
tar_load(rel_water_indiv)
tar_load(rel_water_species_means)
tar_load(filmy_phy)
tar_load(filmy_habit)
tar_load(range_comparison)
tar_load(light_data_all)
tar_load(light_models)
tar_load(filmy_lc_model_params)
tar_load(filmy_lc_model_fitted_data)
tar_load(combined_species_means)
tar_load(gameto_indiv_times)
tar_load(sporo_dt_times)
```

```{r si-load-functions, cache = FALSE}
# Define functions specific to this file
plot_chamber_rh <- function (data, time_limits) {
  ggplot(data, aes(x = date_time, y = 0.01*rh)) +
    geom_line(size = 0.25) +
    scale_x_datetime(limits = time_limits, minor_breaks = "1 day") +
    scale_y_continuous(label = label_percent(accuracy = 1)) +
    labs(y = "Relative humidity") +
    theme(
      legend.position = "none",
      axis.title.x = element_blank())
}

plot_chamber_temp <- function (data, time_limits) {
  ggplot(data, aes(x = date_time, y = temp)) +
    geom_line(size = 0.25) +
    scale_x_datetime(limits = time_limits, minor_breaks = "1 day") +
    scale_y_continuous(label = label_number(suffix = "\u00b0C", accuracy = 1)) +
    labs(y = "Temperature") +
    theme(
      legend.position = "none",
      axis.title.x = element_blank())
}

plot_sporo_chamber_time <- function (data, time_limits) {
  ggplot(data, aes(x = species, ymin = pre, ymax = post, y = post, group = species_duration, linetype = dry_time)) +
    geom_linerange(position = position_dodge(0.5)) +
    geom_point(position = position_dodge(0.5)) +
    scale_y_datetime(limits = time_limits, minor_breaks = "1 day") +
    scale_x_discrete(labels = str_abbrev_sp_pretty) +
    scale_linetype_manual(values = c("15" = "solid", "2" = "solid")) +
    coord_flip() +
    labs(x = "Species") +
    theme(
      axis.title = element_blank(),
      axis.text.y = element_markdown(),
      legend.position = "none"
    )
}

# NaCl plots need separate funcs because they involve color by serial number
make_nacl_time_plot <- function (data, serial_no_cols, time_limits) {
  ggplot(
    data, 
    aes(
      x = species, ymin = pre, ymax = post, y = post, 
      group = species_duration, color = serial_no)
  ) +
  geom_linerange(position = position_dodge(0.5)) +
  geom_point(position = position_dodge(0.5)) +
  scale_y_datetime(limits = time_limits, minor_breaks = "1 day") +
  # Print all 'species' on the y-axis using `drop = false`
  scale_x_discrete(labels = str_abbrev_sp_pretty, drop = FALSE) +
  # Print all levels of 'serial no' in the legend using `drop = false`
  scale_color_manual(values = serial_no_cols, drop = FALSE) +
  labs(x = "Species", color = "Serial no.") +
  coord_flip() +
  theme(
    axis.title = element_blank(),
    axis.text.y = element_markdown()
    )
} 

make_nacl_rh_plot <- function(data, serial_no_cols, time_range, rh_range, groups = FALSE) {
  
  # If groups is TRUE, plot separate lines for different groups of data
  p <- if(groups == TRUE) {
    ggplot(
      data, 
      aes(x = date_time, y = 0.01*rh, color = serial_no, group = interaction(group, serial_no))
    ) 
  } else {
    ggplot(
      data, 
      aes(x = date_time, y = 0.01*rh, color = serial_no)
    )
  }
  
  p +
  geom_line(size = 0.25) +
  scale_color_manual(values = serial_no_cols) +
  scale_x_datetime(limits = time_range, minor_breaks = "1 day") +
  scale_y_continuous(
    label = scales::label_percent(accuracy = 1), 
    limits = rh_range) +
  labs(
    y = "Relative humidity",
    color = "Serial no.") +
  guides(color = "none") +
  theme(axis.title.x = element_blank()) +
  guides(color = "none")
}

make_nacl_temp_plot <- function(data, serial_no_cols, time_range, temp_range, title, groups = FALSE) {
  
  # If groups is TRUE, plot separate lines for different groups of data
  p <- if(groups == TRUE) {
    ggplot(
      data, 
      aes(x = date_time, y = temp, color = serial_no, group = interaction(group, serial_no))
    ) 
  } else {
    ggplot(
      data, 
      aes(x = date_time, y = temp, color = serial_no)
    )
  }
  
  p +
  geom_line(size = 0.25) +
  scale_color_manual(values = serial_no_cols) +
  scale_x_datetime(limits = time_range, minor_breaks = "1 day") +
  scale_y_continuous(
    label = label_number(suffix = "\u00b0C", accuracy = 1), 
    limits = temp_range) +
  labs(
    y = "Temperature",
    color = "Serial no.",
    title = title) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 11),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +
  guides(color = "none")
}

# Define function to plot facetted light curve
make_facet_lc_plot <- function(light_data, lc_model_fitted_data, lc_model_params) {
  
  cbPalette <- c(grey = "#999999", gold = "#E69F00", skyblue = "#56B4E9", 
                 green = "#009E73", yellow = "#F0E442", blue = "#0072B2", 
                 red = "#D55E00", purple = "#CC79A7")
  
  ggplot(mapping = aes(x = par)) +
    geom_point(
      data = light_data, 
      aes(y = etr, alpha = outlier)) +
    geom_line(
      data = lc_model_fitted_data, 
      aes(y = etr_fit)) +
    geom_hline(
      data = lc_model_params, 
      aes(yintercept = etr), color = cbPalette[["blue"]]) +
    geom_vline(
      data = lc_model_params, 
      aes(xintercept = par), color = cbPalette[["red"]]) +
    scale_alpha_manual(values = c("TRUE" = 0.2, "FALSE" = 1.0)) +
    labs(
      y = "ETR<sub>max</sub> (µmol m<sup>-2</sup>·s<sup>-1</sup>)", 
      x = "PPFD (µmol m<sup>-2</sup>·s<sup>-1</sup>)", 
      alpha = "Outlier") +
    theme(
      axis.title.x = element_markdown(),
      axis.title.y = element_markdown(),
      strip.text = element_markdown(),
      plot.title = element_markdown(),
      legend.position = "none"
    ) +
    facet_wrap_paginate(
      vars(str_abbrev_sp_pretty(species), light_id), 
      ncol = 4, nrow = 6, page = 1,
      scales = "free", labeller = label_value_2)
}

#' Cluster times from a sporophyte desiccation tolerance (DT) test
#' 
#' Calculates mean pre- and post-DT test times by species and duration of DT test
#' (2 or 15 days), also adds a `species_duration` column to the output for plotting.
#'
#' @param sporo_time_data Dataframe with DT test data for sporophytes
#' @param salt_select Name of salt to subset data
#' @param k_select Number of groups to cluster. For example, if the DT
#' test was done in 3 groups, `k_select` = 3.
#'
#' @return Dataframe
cluster_sporo_times <- function (sporo_time_data, salt_select, k_select) {
  
  sporo_2d_clusters <- 
    sporo_time_data %>%
    filter(salt == salt_select, dry_time == "2") %>%
    add_clusters("pre", k_select) %>% # choose K by inspecting raw data first
    group_by(species, cluster, salt, dry_time) %>%
    summarize(pre = mean(pre), post = mean(post), n = n(), .groups = "drop") # %>%
  # select(-cluster)
  
  sporo_15d_clusters <- 
    sporo_time_data %>%
    filter(salt == salt_select, dry_time == "15") %>%
    add_clusters("pre", k_select) %>%
    group_by(species, cluster, salt, dry_time) %>%
    summarize(pre = mean(pre), post = mean(post), n = n(), .groups = "drop") # %>%
  # select(-cluster)
  
  bind_rows(sporo_2d_clusters, sporo_15d_clusters) %>%
    mutate(species_duration = paste(species, dry_time))
  
}
```

```{r si-plot-setup}
# JPR requirements:
# Figures should be 39 mm, 84 mm, 129 mm, or 174 mm wide and not higher than 234 mm
# In inches, widths: 1.53, 3.31, 5.08, 6.85; height: 9.21

# Set overall theme, saving default theme
default_theme <- theme_set(
  theme_bw(base_size = 10) +
    theme(panel.grid.minor = element_blank()))

# Define color-blind palette
cbPalette <- c(grey = "#999999", gold = "#E69F00", skyblue = "#56B4E9", 
               green = "#009E73", yellow = "#F0E442", blue = "#0072B2", 
               red = "#D55E00", purple = "#CC79A7")

# Set colors for growth habit, generation
habit_colors <- c(
  "Terrestrial" = cbPalette[["red"]], 
  "Saxicolous" = cbPalette[["gold"]], 
  "Low_Epiphyte" = cbPalette[["green"]],
  "High_Epiphyte" = cbPalette[["blue"]])
```

**Electronic supplementary materials: Online Resource 1** 

**Title:** Intergenerational niche differentiation in filmy ferns (Hymenophyllaceae)

**Authors:** Nitta JH; Watkins JE; Holbrook NM; Taputuarai R; Wang T; Davis CC

**Journal:** Journal of Plant Research 

**Corresponding author:** Joel H. Nitta  
Department of Biological Sciences, Graduate School of Science, The University of Tokyo, 2-11-16 Yayoi, Bunkyo-ku, Tokyo, 113-0032, Japan  
Phone: +81-  
Fax: +81-  
email: joelnitta\@gmail.com

**Content:** \figs `r s_figure_num("tree")`--`r s_figure_num("capi-water")`

**`r s_figure("tree")`**. Maximum likelihood ultrametric phylogenetic tree including all filmy fern species from Moorea, French Polynesia.

**`r s_figure("chamber")`**. Temperature, relative humidity (RH), and duration of desiccation treatment of filmy ferns from Moorea, French Polynesia.

**`r s_figure("range")`**. Elevational range (m) of sporophytes and gametophytes of filmy ferns on Moorea, French Polynesia.

**`r s_figure("dt-control")`**. Recovery of controls (samples kept on moist tissues) for desiccation tolerance test of filmy ferns from Moorea, French Polynesia. 

**`r s_figure("water-all")`**. Relative water content (RWC) of sporophytes after desiccation by duration of desiccation treatment (2 or 15 days).

**`r s_figure("water-s")`**. Relative water content (RWC) of sporophytes during desiccation tolerance test.

**`r s_figure("light-curves")`**. Rapid light response curves of filmy ferns from Moorea, French Polynesia.

**`r s_figure("traits-box")`**. Box plots comparing physiological parameters between sporophytes (red) and gametophytes (blue) across growth habits in filmy ferns from Moorea, French Polynesia.

**`r s_figure("capi-water")`**. Recovery of *Callistopteris apiifolia* gametophytes from Moorea, French Polynesia from desiccation treatment at 100 % RH (water used in place of desiccation salt).

\newpage

```{r full-phylo, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Copy phylogeny and species means data so they
# can be manipulated for this plot
phy <- filmy_phy
habit <- filmy_habit

# Set colors for growth habit, generation
habit_colors <- c(
  "Terrestrial" = cbPalette[["red"]], 
  "Saxicolous" = cbPalette[["gold"]], 
  "Low_Epiphyte" = cbPalette[["green"]],
  "High_Epiphyte" = cbPalette[["blue"]])

generation_colors <- c(
  "gametophyte" = "grey70",
  "sporophyte" = "grey30"
)

# Filter growth habit data to only species in phylogeny
habit <-
  habit %>%
  filter(species %in% phy$tip.label)

# Convert underscores to spaces
# phy$tip.label <- str_replace_all(phy$tip.label, "_", "~")

# Make a tibble of bootstrap values to map onto tree
# - needs one column with "node", the other can be named as we like
# - hard-code node ID: internal nodes start after tip nodes,
#   and phy$node.label is in the same order as internal nodes
bs_tibble <- tibble(
  node=1:Nnode(phy) + Ntip(phy), 
  # Don't print BS < 50%
  bootstrap = ifelse(phy$node.label < 50, "", phy$node.label))

# Join growth habit and BS data to ggtree object
ggtree(phy) %<+% filmy_habit %<+% bs_tibble +
  geom_text(aes(label=bootstrap), hjust=-.25, size = 3, color = "grey30") +
  geom_tippoint(aes(color = habit), position = position_nudge(x = 0, y = 0), size = 4) +
  # Add species labels
  geom_tiplab(
    # getting species names into italics is painful....
    # need to use plotmath() parsing.
    # to print a space, use `~`
    # e.g., `italic("Hymenophyllum~polyanthos")`
    aes(label=paste0('italic(', str_replace_all(label, "_", "~"), ')')), 
    parse = TRUE,
    hjust = -0.02) +
  # There is no way modify the text in geom_treescale (to add units), so make the
  # text disappear by setting fontsize = 0
  geom_treescale(y = 20, x = 0, width = 40, fontsize = 0) +
  # Manually place custom label above scale bar
  annotate("text", x = 20, y = 20, label = "40 my", size = 3, vjust = -1) +
  # Scale colors by growth habit
  scale_color_manual(values = habit_colors, labels = pretty_text) +
  labs(color = "Growth habit") +
  # Need to remove clip so that species names print properly
  coord_cartesian(clip = "off") +
  theme(
    plot.margin = margin(t = 0, r = 2.2, b = 0, l = 0, unit = "in"),
    legend.position = "bottom"
  )
```

**`r s_figure("tree")`**. Maximum likelihood ultrametric phylogenetic tree including all filmy fern species from Moorea, French Polynesia.
Tree obtained by extracting Hymenophyllaceae from the tree of Nitta et al. (2016) with the extract.clade function of the ape package in R (Paradis et al., 2004).
Bootstrap support values >50% shown at nodes.
Growth habit indicated by colored dots. 
*Crepidomanes bipunctatum* and *C. humile* were observed growing as both epiphytes and saxicoles, but are shown as epiphytes to distinguish them from exclusively saxicolous species.

```{r sporophyte-dt-prep}
# Extract pre- and post-DT treatment times for sporophytes
sporo_times <-
  filmy_dt %>%
  filter(generation == "sporophyte") %>%
  select(species:dataset, contains("time_")) %>%
  pivot_longer(names_to = "condition", values_to = "date_time", contains("time_")) %>%
  filter(!is.na(date_time)) %>%
  mutate(condition = str_remove_all(condition, "time_") %>%
           # Consider first recovery measurement (at 30 min) to be "post-DT treatment"
           str_replace_all("30min", "post")) %>%
  filter(condition %in% c("pre", "post")) %>%
  add_count(species, salt, dry_time, individual, dataset) %>%
  filter(n > 1) %>%  # only keep those with both pre- and post- times
  select(-n) %>%
  pivot_wider(names_from = "condition", values_from = "date_time")
```

\blandscape

```{r change-theme-1}
previous_theme <- theme_set(theme_bw(base_size = 10))
```

```{r sporophyte-dt-LiCl, fig.height = 6.6, fig.width = 9, fig.cap = ""}
# Get mean times of each cluster of DT test samples for the selected drying salt
licl_clusters_2013 <- cluster_sporo_times(filter(sporo_times, str_detect(dataset, "2013")), "LiCl", 3)
licl_clusters_2014 <- cluster_sporo_times(filter(sporo_times, str_detect(dataset, "2014")), "LiCl", 1)

licl_clusters <- bind_rows(licl_clusters_2013, licl_clusters_2014) %>%
  bind_rows(filter(sporo_dt_times, salt == "LiCl")) %>%
  mutate(species_duration = paste(species, dry_time))

# Calculate time range for the clustered data
licl_time_range_2013 <- c(min = min(licl_clusters_2013$pre), max = max(licl_clusters_2013$post))
licl_time_range_2014 <- c(min = min(licl_clusters_2014$pre), max = max(licl_clusters_2014$post))

# Subset DT chamber data
licl_chamber_data_2012 <- 
  filter(filmy_dt_chamber, 
         date_time > "2012-07-31 18:10:00 UTC", 
         date_time < "2013-01-01 00:10:00 UTC",
         salt == "LiCl")

licl_time_range_2012 <- c(
  # Manually entered data for sporo dt times LiCl was slightly earlier than 
  # when started datalogger recording
  min = filter(sporo_dt_times, salt == "LiCl") %>% pull(pre) %>% min, 
  max = max(licl_chamber_data_2012$date_time)
  )

licl_chamber_data_2013 <-
  filter(filmy_dt_chamber, 
         date_time >= licl_time_range_2013[["min"]], 
         date_time <= licl_time_range_2013[["max"]], 
         salt == "LiCl")
licl_chamber_data_2014 <- 
  filter(filmy_dt_chamber, 
         date_time >= licl_time_range_2014[["min"]], 
         date_time <= licl_time_range_2014[["max"]], 
         salt == "LiCl") %>%
  # There are two sets of times: 2014-06-17 to 2014-07-02, and 2014-07-06 to 2014-07-08
  # Add a group for these so ggplot doesn't connect lines betweeen them
  mutate(
    day = yday(date_time),
    group = ifelse(day < 185, "a", "b"))

licl_chamber_data <- bind_rows(licl_chamber_data_2012, licl_chamber_data_2013, licl_chamber_data_2014)
licl_temp_range <- c(min(licl_chamber_data$temp), max(licl_chamber_data$temp))
licl_rh_range <- c(min(licl_chamber_data$rh), max(licl_chamber_data$rh))*0.01

# Temp plots
licl_temp_plot_2014 <- ggplot(licl_chamber_data_2014, aes(x = date_time, y = temp, group = group)) +
  geom_line(size = 0.25) +
  scale_x_datetime(limits = licl_time_range_2014) +
  scale_y_continuous(
    label = label_number(suffix = "\u00b0C", accuracy = 1), 
    limits = licl_temp_range) +
  labs(
    y = "Temperature",
    title = "2014") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 11),
    legend.position = "none") +
  blank_y_theme() +
  blank_x_theme()

licl_temp_plot_2013 <- plot_chamber_temp(licl_chamber_data_2013, licl_time_range_2013) +
  scale_y_continuous(limits = licl_temp_range) +
  labs(title = "2013") +
  theme(plot.title = element_text(hjust = 0.5, size = 11)) +
  blank_y_theme() +
  blank_x_theme()

licl_temp_plot_2012 <- plot_chamber_temp(licl_chamber_data_2012, licl_time_range_2012) +
  scale_y_continuous(limits = licl_temp_range) +
  labs(title = "2012") +
  theme(plot.title = element_text(hjust = 0.5, size = 11)) +
  blank_x_theme()

# RH plots
licl_rh_plot_2014 <- ggplot(licl_chamber_data_2014, aes(x = date_time, y = 0.01*rh, group = group)) +
  geom_line(size = 0.25) +
  scale_x_datetime(limits = licl_time_range_2014) +
  scale_y_continuous(
    label = label_percent(accuracy = 1), 
    limits = licl_rh_range) +
  labs(y = "Relative humidity") +
  theme(legend.position = "none") +
  blank_x_theme() +
  blank_y_theme()

licl_rh_plot_2013 <- plot_chamber_rh(licl_chamber_data_2013, licl_time_range_2013) +
  scale_y_continuous(limits = licl_rh_range, label = label_percent(accuracy = 1)) +
  blank_y_theme() +
  blank_x_theme()

licl_rh_plot_2012 <- plot_chamber_rh(licl_chamber_data_2012, licl_time_range_2012) +
  scale_y_continuous(limits = licl_rh_range, label = label_percent(accuracy = 1)) +
  blank_x_theme()

# Dry times plot
licl_time_plot_2012 <- plot_sporo_chamber_time(licl_clusters, licl_time_range_2012) 
licl_time_plot_2013 <- plot_sporo_chamber_time(licl_clusters, licl_time_range_2013) +
  blank_y_theme()
licl_time_plot_2014 <- plot_sporo_chamber_time(licl_clusters, licl_time_range_2014) +
  blank_y_theme()

# Combine plots
licl_temp_plot_2012 + licl_temp_plot_2013 + licl_temp_plot_2014 +
  licl_rh_plot_2012 + licl_rh_plot_2013 + licl_rh_plot_2014 +
  licl_time_plot_2012 + licl_time_plot_2013 + licl_time_plot_2014 +
  plot_layout(ncol = 3, nrow = 3, guides = "collect") +
  plot_annotation(title = "a") &
  theme(plot.tag = element_text(face = "bold"))
```

```{r sporophyte-dt-MgNO3, fig.height = 6.5, fig.width = 9, fig.cap = ""}
# Get mean times of each cluster of DT test samples for the selected drying salt
mgno3_clusters_2013 <- cluster_sporo_times(filter(sporo_times, str_detect(dataset, "2013")), "MgNO3", 3)
mgno3_clusters_2014 <- cluster_sporo_times(filter(sporo_times, str_detect(dataset, "2014")), "MgNO3", 1)

mgno3_clusters <- bind_rows(mgno3_clusters_2013, mgno3_clusters_2014) %>%
  bind_rows(filter(sporo_dt_times, salt == "MgNO3")) %>%
  mutate(species_duration = paste(species, dry_time))

# Calculate time range for the clustered data
mgno3_time_range_2013 <- c(min = min(mgno3_clusters_2013$pre), max = max(mgno3_clusters_2013$post))
mgno3_time_range_2014 <- c(min = min(mgno3_clusters_2014$pre), max = max(mgno3_clusters_2014$post))

# Subset DT chamber data
mgno3_chamber_data_2012 <- 
  filter(filmy_dt_chamber, 
         date_time > "2012-07-31 18:10:00 UTC", 
         date_time < "2013-01-01 00:10:00 UTC",
         salt == "MgNO3")

mgno3_time_range_2012 <- c(
  # Manually entered data for sporo dt times LiCl was slightly earlier than 
  # when started datalogger recording
  min = filter(sporo_dt_times, salt == "MgNO3") %>% pull(pre) %>% min, 
  max = max(mgno3_chamber_data_2012$date_time)
  )

mgno3_chamber_data_2013 <-
  filter(filmy_dt_chamber, 
         serial_no == "10342564",
         date_time >= mgno3_time_range_2013[["min"]], 
         date_time <= mgno3_time_range_2013[["max"]], 
         salt == "MgNO3")
mgno3_chamber_data_2014 <- 
  filter(filmy_dt_chamber, 
         date_time >= mgno3_time_range_2014[["min"]], 
         date_time <= mgno3_time_range_2014[["max"]], 
         salt == "MgNO3") %>%
  # There are two sets of times: 2014-06-17 to 2014-07-02, and 2014-07-06 to 2014-07-08
  # Add a group for these so ggplot doesn't connect lines betweeen them
  mutate(
    day = yday(date_time),
    group = ifelse(day < 185, "a", "b"))

mgno3_chamber_data <- bind_rows(mgno3_chamber_data_2012, mgno3_chamber_data_2013, mgno3_chamber_data_2014)
mgno3_temp_range <- c(min(mgno3_chamber_data$temp), max(mgno3_chamber_data$temp))
mgno3_rh_range <- c(min(mgno3_chamber_data$rh), max(mgno3_chamber_data$rh))*0.01

# Temp plots
mgno3_temp_plot_2014 <- ggplot(mgno3_chamber_data_2014, aes(x = date_time, y = temp, group = group)) +
  geom_line(size = 0.25) +
  scale_x_datetime(limits = mgno3_time_range_2014) +
  scale_y_continuous(
    label = label_number(suffix = "\u00b0C", accuracy = 1), 
    limits = mgno3_temp_range) +
  labs(
    y = "Temperature",
    title = "2014") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 11),
    legend.position = "none") +
  blank_x_theme() +
  blank_y_theme()

mgno3_temp_plot_2013 <- plot_chamber_temp(mgno3_chamber_data_2013, mgno3_time_range_2013) +
  scale_y_continuous(limits = mgno3_temp_range) +
  labs(title = "2013") +
  theme(plot.title = element_text(hjust = 0.5, size = 11)) +
  blank_y_theme() +
  blank_x_theme()

mgno3_temp_plot_2012 <- plot_chamber_temp(mgno3_chamber_data_2012, mgno3_time_range_2012) +
  scale_y_continuous(limits = mgno3_temp_range) +
  labs(title = "2012") +
  theme(plot.title = element_text(hjust = 0.5, size = 11)) +
  blank_x_theme()

# RH plots
mgno3_rh_plot_2014 <- ggplot(mgno3_chamber_data_2014, aes(x = date_time, y = 0.01*rh, group = group)) +
  geom_line(size = 0.25) +
  scale_x_datetime(limits = mgno3_time_range_2014, minor_breaks = "1 day") +
  scale_y_continuous(
    label = label_percent(accuracy = 1), 
    limits = mgno3_rh_range) +
  labs(y = "Relative humidity") +
  theme(legend.position = "none") +
  blank_y_theme() +
  blank_x_theme()

mgno3_rh_plot_2013 <- plot_chamber_rh(mgno3_chamber_data_2013, mgno3_time_range_2013) +
  scale_y_continuous(limits = mgno3_rh_range, label = label_percent(accuracy = 1)) +
  blank_y_theme() +
  blank_x_theme()

mgno3_rh_plot_2012 <- plot_chamber_rh(mgno3_chamber_data_2012, mgno3_time_range_2012) +
  scale_y_continuous(limits = mgno3_rh_range, label = label_percent(accuracy = 1)) +
  blank_x_theme()

# Dry times plot
mgno3_time_plot_2012 <- plot_sporo_chamber_time(mgno3_clusters, mgno3_time_range_2012)
mgno3_time_plot_2013 <- plot_sporo_chamber_time(mgno3_clusters, mgno3_time_range_2013) +
  blank_y_theme()
mgno3_time_plot_2014 <- plot_sporo_chamber_time(mgno3_clusters, mgno3_time_range_2014) +
  blank_y_theme()

# Combine plots
mgno3_temp_plot_2012 + mgno3_temp_plot_2013 + mgno3_temp_plot_2014 +
  mgno3_rh_plot_2012 + mgno3_rh_plot_2013 + mgno3_rh_plot_2014 +
  mgno3_time_plot_2012 + mgno3_time_plot_2013 + mgno3_time_plot_2014 +
  plot_layout(ncol = 3, nrow = 3, guides = "collect") +
  plot_annotation(title = "b") &
  theme(plot.tag = element_text(face = "bold"))
```

```{r sporophyte-dt-NaCl, fig.height = 6.5, fig.width = 9, fig.cap = ""}
# Subset desiccation duration data
nacl_clusters_2012 <- filter(sporo_dt_times, salt == "NaCl") %>%
  mutate(
    serial_no = case_when(
      species %in% c(
        "Hymenophyllum_polyanthos", "Crepidomanes_humile", 
        "Crepidomanes_bipunctatum", "Polyphlebium_endlicherianum", 
        "Crepidomanes_minutum2") ~ "3200919",
      species == "Callistopteris_apiifolia" ~ "10140667, 10140659",
      TRUE ~ NA_character_
    )
  ) %>%
  mutate(year = "2012", species_duration = paste(species, dry_time))

# H_polyanthos shows n=1, but this is only because pre/post were available for only one sample
# (actually had 8 samples total)
nacl_clusters_2013 <- 
  sporo_times %>%
  filter(str_detect(dataset, "2013")) %>%
  cluster_sporo_times("NaCl", 4) %>%
  # Exclude A. dentatum, which is lacking chamber datalogger data
  filter(species != "Abrodictyum_dentatum") %>%
  mutate(
    serial_no = case_when(
      species %in% c("Didymoglossum_tahitense", "Crepidomanes_kurzii", "Callistopteris_apiifolia") & dry_time == "2" ~ "missing",
      species %in% c("Hymenophyllum_multifidum", "Hymenophyllum_digitatum") ~ "10140667",
      species %in% c("Hymenophyllum_polyanthos") ~ "10152774",
      TRUE ~ "missing"
    )
  ) %>%
  mutate(year = "2013")

nacl_clusters_2014 <-
  sporo_times %>%
  filter(str_detect(dataset, "2014")) %>%
  cluster_sporo_times("NaCl", 1) %>%
  mutate(
    serial_no = case_when(
      species %in% c("Vandenboschia_maxima") & dry_time == "2" ~ "10140661",
      TRUE ~ "10152773"
    )
  ) %>%
  mutate(year = "2014")

# Calculate time range for the clustered data
# to standardize x-axis
nacl_time_range_2012 <- c(min = min(nacl_clusters_2012$pre), max = max(nacl_clusters_2012$post))
nacl_time_range_2013 <- c(min = min(nacl_clusters_2013$pre), max = max(nacl_clusters_2013$post))
nacl_time_range_2014 <- c(min = min(nacl_clusters_2014$pre), max = max(nacl_clusters_2014$post))

nacl_chamber_data_2012 <-
  filmy_dt_chamber %>%
  mutate(year = as.character(year)) %>%
  filter(
    date_time >= nacl_time_range_2012[["min"]], 
    date_time <= nacl_time_range_2012[["max"]], 
    salt == "NaCl")

nacl_chamber_data_2013 <-
  filmy_dt_chamber %>%
  mutate(year = as.character(year)) %>%
  filter( 
    date_time >= nacl_time_range_2013[["min"]], 
    date_time <= nacl_time_range_2013[["max"]], 
    salt == "NaCl")

nacl_chamber_data_2014 <- 
  filmy_dt_chamber %>%
  mutate(year = as.character(year)) %>%
  filter( 
    date_time >= nacl_time_range_2014[["min"]], 
    date_time <= nacl_time_range_2014[["max"]], 
    salt == "NaCl") %>%
  mutate(
    # There are two sets of times: 2014-06-17 to 2014-07-02, and 2014-07-06 to 2014-07-08
    # Add a group for these so ggplot doesn't connect lines betweeen them
    day = yday(date_time),
    group = ifelse(day < 185, "a", "b")
  )

# Set up color palette for serial numbers
serial_no_cols <- c(
  brewer_pal(palette = "Dark2")(8),
  "grey20") %>%
  set_names(
    bind_rows(
      nacl_clusters_2012, nacl_clusters_2013, nacl_clusters_2014, 
      nacl_chamber_data_2012, nacl_chamber_data_2013, nacl_chamber_data_2014) %>%
      filter(serial_no != "missing", !is.na(serial_no)) %>%
      pull(serial_no) %>%
      unique %>%
      sort %>%
      c("missing")
  )

# Combine NaCl data so that factor levels are same across years
nacl_chamber_data <- bind_rows(nacl_chamber_data_2012, nacl_chamber_data_2013, nacl_chamber_data_2014) %>%
  mutate(
    year = as.character(year),
    serial_no = as.factor(serial_no) %>% 
      fct_expand(names(serial_no_cols)) %>% 
      fct_relevel(function (x) sort(x, decreasing = TRUE)) %>%
      fct_relevel("10140667, 10140659", after = Inf) %>%
      fct_relevel("missing", after = Inf))

nacl_clusters <- bind_rows(nacl_clusters_2012, nacl_clusters_2013, nacl_clusters_2014) %>%
  mutate(
    species = as.factor(species) %>% fct_relevel(function (x) sort(x, decreasing = TRUE)),
    serial_no = as.factor(serial_no) %>% 
      fct_expand(names(serial_no_cols)) %>% 
      fct_relevel(function (x) sort(x, decreasing = TRUE)) %>%
      fct_relevel("10140667, 10140659", after = Inf) %>%
      fct_relevel("missing", after = Inf))

# Get overall range of temperature and RH for NaCl
# to standardize y-axis
nacl_temp_range <- nacl_chamber_data %>%
  summarize(min = min(temp), max = max(temp)) %>%
  pivot_longer(everything()) %>%
  arrange(value) %>%
  pull(value)

nacl_rh_range <- nacl_chamber_data %>%
  mutate(rh = rh * 0.01) %>%
  summarize(min = min(rh), max = max(rh)) %>%
  pivot_longer(everything()) %>%
  arrange(value) %>%
  pull(value)

# Time plots
nacl_time_plot_2012 <- make_nacl_time_plot(
  nacl_clusters %>% filter(year == "2012"), serial_no_cols, nacl_time_range_2012)

nacl_time_plot_2013 <- make_nacl_time_plot(
  nacl_clusters %>% filter(year == "2013"), serial_no_cols, nacl_time_range_2013) +
  blank_y_theme() +
  guides(color = "none")

nacl_time_plot_2014 <- make_nacl_time_plot(
  nacl_clusters %>% filter(year == "2014"), serial_no_cols, nacl_time_range_2014) +
  blank_y_theme() +
  guides(color = "none")

# RH plots
nacl_rh_plot_2012 <- make_nacl_rh_plot(
  nacl_chamber_data %>% filter(year == "2012"),
  serial_no_cols,
  nacl_time_range_2012, 
  nacl_rh_range
)
  
nacl_rh_plot_2013 <- make_nacl_rh_plot(
  nacl_chamber_data %>% filter(year == "2013"),
  serial_no_cols,
  nacl_time_range_2013, 
  nacl_rh_range
) + 
  blank_y_theme() +
  blank_x_theme()

nacl_rh_plot_2014 <- make_nacl_rh_plot(
  nacl_chamber_data %>% filter(year == "2014"),
  serial_no_cols,
  nacl_time_range_2014, 
  nacl_rh_range,
  groups = TRUE
) + 
  blank_y_theme() +
  blank_x_theme()

# Temp plots
nacl_temp_plot_2012 <- make_nacl_temp_plot(
  nacl_chamber_data %>% filter(year == "2012"),
  serial_no_cols,
  nacl_time_range_2012, 
  nacl_temp_range,
  title = "2012") +
  guides(color = "none")

nacl_temp_plot_2013 <- make_nacl_temp_plot(
  nacl_chamber_data %>% filter(year == "2013"),
  serial_no_cols,
  nacl_time_range_2013, 
  nacl_temp_range,
  title = "2013") + 
  blank_y_theme() +
  blank_x_theme()

nacl_temp_plot_2014 <- make_nacl_temp_plot(
  nacl_chamber_data %>% filter(year == "2014"),
  serial_no_cols,
  nacl_time_range_2014, 
  nacl_temp_range,
  title = "2014",
  groups = TRUE) + 
  blank_y_theme() +
  blank_x_theme()

# Combine plots
nacl_temp_plot_2012 + nacl_temp_plot_2013 + nacl_temp_plot_2014 +
  nacl_rh_plot_2012 + nacl_rh_plot_2013 + nacl_rh_plot_2014 +
  nacl_time_plot_2012 + nacl_time_plot_2013 + nacl_time_plot_2014 +
  plot_layout(ncol = 3, nrow = 3, guides = "collect") +
  plot_annotation(title = "c") &
  theme(
    plot.tag = element_text(face = "bold"),
    legend.position = "bottom")
```

\elandscape

\newpage

```{r gametophyte-dt, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Combine and calculate mean start/end times by group (cluster)
gameto_mean_times <-
  gameto_indiv_times %>%
  mutate(cluster = as.factor(cluster)) %>%
  group_by(cluster) %>%
  summarize(pre = mean(pre), post = mean(post), n = n(), .groups = "drop")

# Set time limits so plots line up vertically
gameto_times_2012 <- gameto_mean_times %>% filter(pre < "2013-01-01")
gameto_times_2013 <- gameto_mean_times %>% filter(pre > "2013-01-01")
gameto_time_limits_2013 <- c(min = min(gameto_times_2013$pre), max = max(gameto_times_2013$post))
gameto_time_limits_2012 <- c(min = min(gameto_times_2012$pre), max = max(gameto_times_2012$post))

# Subset DT chamber data
chamber_gameto_2013 <- filmy_dt_chamber %>% filter(generation == "gametophyte", year == "2013")
chamber_gameto_2012 <- filmy_dt_chamber %>% 
  filter(
    salt == "MgNO3", 
    year == "2012",
    generation == "gametophyte") %>%
  mutate(group = case_when(
    date_time < "2012-07-17 00:00:00" ~ "a",
    date_time > "2012-07-17 00:00:00" ~ "b"
  ))

# DT start/end times plot
dt_times_gameto_2013_plot <- ggplot(
  gameto_mean_times, 
  aes(x = cluster, ymin = pre, ymax = post, y = post, group = cluster)) +
  geom_linerange(position = position_dodge(0.5)) +
  geom_point(position = position_dodge(0.5)) +
  scale_y_datetime(limits = gameto_time_limits_2013) +
  coord_flip() +
  labs(x = "Batch") +
  theme(
    axis.title.x = element_blank()
  )

dt_times_gameto_2012_plot <- ggplot(
  gameto_mean_times, 
  aes(x = cluster, ymin = pre, ymax = post, y = post, group = cluster)) +
  geom_linerange(position = position_dodge(0.5)) +
  geom_point(position = position_dodge(0.5)) +
  scale_y_datetime(limits = gameto_time_limits_2012) +
  coord_flip() +
  labs(x = "Batch") +
  theme(
    axis.title.x = element_blank()
  ) +
  blank_y_theme()

# RH plot
chamber_gameto_2013_rh_plot <-
  plot_chamber_rh(chamber_gameto_2013, gameto_time_limits_2013)

chamber_gameto_2012_rh_plot <-
  ggplot(chamber_gameto_2012, aes(x = date_time, y = 0.01*rh, group = group)) +
  geom_line(size = 0.25) +
  scale_x_datetime(limits = gameto_time_limits_2012) +
  scale_y_continuous(label = label_percent(accuracy = 1)) +
  labs(y = "Relative humidity") +
  theme(
    legend.position = "none",
    axis.title.x = element_blank()) +
  blank_y_theme()

# Temp plot
chamber_gameto_2013_temp_plot <-
  plot_chamber_temp(chamber_gameto_2013, gameto_time_limits_2013) +
  labs(title = "2013") +
  theme(plot.title = element_text(hjust = 0.5, size = 11))

chamber_gameto_2012_temp_plot <-
  ggplot(chamber_gameto_2012, aes(x = date_time, y = temp, group = group)) +
  geom_line(size = 0.25) +
  scale_x_datetime(limits = gameto_time_limits_2012) +
  scale_y_continuous(label = label_number(suffix = "\u00b0C", accuracy = 1)) +
  labs(
    y = "Temperature",
    title = "2012") +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 11),
    axis.title.x = element_blank()) +
  blank_y_theme()

# Combine into final plot
chamber_gameto_2013_temp_plot + chamber_gameto_2012_temp_plot +
  chamber_gameto_2013_rh_plot + chamber_gameto_2012_rh_plot + 
  dt_times_gameto_2013_plot + dt_times_gameto_2012_plot + 
  plot_layout(ncol = 2, nrow = 3) +
  plot_annotation(title = "d") &
  theme(plot.tag = element_text(face = "bold"))
```

\newpage

**`r s_figure("chamber")`**. Temperature, relative humidity (RH), and duration of desiccation treatment of filmy ferns from Moorea, French Polynesia. **a**--**c**, sporophytes; **d**, gametophytes. Relative humidity was controlled by placing drying salts inside desiccation chambers: **a**, LiCl (-282 MPa, 18 % RH); **b**, **d**, Mg(NO~3~)~2~ (-86 MPa, 58 % RH); **c**, NaCl (-38 MPa, 80 % RH). Temperature and RH measured with Track-It RH/Temp dataloggers logging every 10 min (2012 species other than *Callistopteris apiifolia*) or Hobo ProV2 dataloggers logging every 5 min (2012 *C. apiifolia*, 2013, 2014). For NaCl (**c**), multiple chambers were set up and tracked with different data loggers; serial number of data logger indicated by color; "missing" indicates correspondence between samples and data loggers (chambers) unknown; *C. apiifolia* samples divided into two chambers. For bottom-most panels (duration of desiccation treatment), line indicates duration of treatment and point indicates removal of sample from chamber. Gametophytes were measured in batches; membership of individual gametophytes to each batch can be found in `r s_table("gameto-batches")` (Online Resource 2).

\newpage

```{r change-theme-2}
# Change theme back after DT chamber plots
theme_set(previous_theme)
```

```{r range-plot, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Make plot showing range of gametophytes beyond sporophytes
plot_data <-
  range_comparison %>%
  left_join(filmy_habit, by = "species") %>%
  mutate(species = fct_reorder(species, sporo_mean_el)) %>%
  mutate(
    gameto_max_el = case_when(
      is.na(gameto_max_el) ~ sporo_max_el,
      sporo_max_el > gameto_max_el ~ sporo_max_el,
      TRUE ~ gameto_max_el
    ),
    gameto_min_el = case_when(
      is.na(gameto_min_el) ~ sporo_min_el,
      sporo_min_el < gameto_min_el ~ sporo_min_el,
      TRUE ~ gameto_min_el
    )
  )

ggplot(plot_data, aes(y = species)) +
  # Gameto range as line for those with different min/max elevation
  geom_linerange(aes(xmin = gameto_min_el, xmax = gameto_max_el), color = "grey10") +
  # Gameto range as point for those with single elevation, if different from sporo elevation
  geom_point(
    data = filter(
      plot_data,
      gameto_min_el == gameto_max_el, gameto_min_el != sporo_min_el, gameto_max_el != sporo_max_el),
    aes(x = sporo_mean_el), 
    fill = "grey10"
  ) +
  # Sporo range as fat line for those with different min/max elevation
  geom_linerange(
    data = filter(plot_data, sporo_min_el != sporo_max_el),
    aes(xmin = sporo_min_el, xmax = sporo_max_el, color = habit), 
    size = 3, fill = "grey10") +
  # Sporo range as point for those with single elevation
  geom_point(
    data = filter(plot_data, sporo_min_el == sporo_max_el),
    aes(x = sporo_mean_el, color = habit)
  ) +
  # Diamond for gameto min el below sporo min el
  geom_point(
    data = filter(range_comparison, gameto_min_el < sporo_min_el), 
    aes(x = gameto_min_el),
    shape = 23, fill = "grey10") +
  # Diamond for gameto min el above sporo max el
  geom_point(
    data = filter(range_comparison, gameto_max_el > sporo_max_el),
    aes(x = gameto_max_el),
    shape = 23, fill = "grey10") +
  scale_color_manual(values = habit_colors, labels = pretty_text) +
  scale_y_discrete(labels = pretty_text) +
  labs(x = "Elevation (m)", y = "Species", color = "Growth habit") +
  theme(
    legend.position = "bottom",
    axis.text.y = element_text(face = "italic")
  )
```

**`r s_figure("range")`**. Elevational range (m) of sporophytes and gametophytes of filmy ferns on Moorea, French Polynesia. Elevational range width shown with colored bars (sporophytes) or black lines (gametophytes). Species observed only at a single elevation (not a range) shown with points. Extent of range of gametophytes beyond sporophytes shown with black diamonds. Color indicates growth habit. Presence of gametophytes assumed at sites where sporophytes were observed, even if gametophytes of that species were not collected from that site.

```{r water-content-prep}
# Define color-blind palette
cbPalette <- c(grey = "#999999", gold = "#E69F00", skyblue = "#56B4E9", 
               green = "#009E73", yellow = "#F0E442", blue = "#0072B2", 
               red = "#D55E00", purple = "#CC79A7")

# Set colors, shapes for desiccation intensity
salt_cols <- c(
  "NaCl" = cbPalette[["blue"]], 
  "MgNO3" = cbPalette[["yellow"]], 
  "LiCl" = cbPalette[["red"]], 
  "Control" = "white")

salt_shapes <- c(
  "NaCl" = 21, # circle
  "MgNO3" = 24, # triangle
  "LiCl" = 23, # diamond
  "Control" = 22 # square
)
```

```{r sporo-dt-controls, fig.height = 8, fig.width = 7, fig.cap = ""}
# Plot sporophyte DT controls

# Set dodge spacing, colors
pd <- position_dodge(.7)

# Prepare data for plotting
dt_control_plot_data <-
  # Start with DT data
  filmy_dt %>%
  filter(salt == "Control") %>%
  # Filter out individuals with low pre-treatment yields
  filter(!is.na(yield_pre), yield_pre > 400) %>%
  # Calculate recovery by individual
  verify(yield_pre > 0) %>%
  assert(not_na, yield_pre) %>%
  select(species, salt, dry_time, individual, dataset, generation, contains("yield")) %>%
  select(-yield_72hr, -contains("yield_dry")) %>%
  pivot_longer(names_to = "rec_time", values_to = "yield_recover", matches("30|24|48")) %>%
  mutate(
    rec_time = str_remove_all(rec_time, "yield_"),
    recovery = yield_recover / yield_pre) %>%
  select(-contains("yield")) %>%
  # Calculate mean recovery by species and dataset
  mutate(rec_time = factor(rec_time, levels = c("30min", "24hr", "48hr"))) %>%
  group_by(species, salt, dry_time, rec_time, generation, dataset) %>%
  summarize(
    recovery_mean = mean(recovery, na.rm = TRUE),
    sd = sd(recovery, na.rm = TRUE),
    n = n(),
    .groups = "drop") %>%
  rename(recovery = recovery_mean) %>%
  # Add growth habit data
  left_join(filmy_habit, by = "species") %>%
  assert(not_na, habit) %>%
  mutate(
    habit = str_replace_all(habit, "_", " ") %>% 
      str_to_sentence() %>%
      factor(levels = c("Terrestrial", "Saxicolous", "Low epiphyte", "High epiphyte"))) %>%
  # Add dataset year
  mutate(year = str_split(dataset, "_") %>% map_chr(1)) %>%
  # Abbreviate species names to "G. species"
  mutate(
    species = str_replace_all(species, "[a-z]+_", ". "),
    species = glue("*{species}*")) %>%
  # Add year to species names with multiple datasets
  add_count(species, name = "n_species") %>%
  mutate(species = ifelse(n_species > 6 & generation == "sporophyte", paste(species, year), species)) %>%
  select(-n_species) %>%
  # Only keep rows with recovery
  filter(!is.na(recovery))

# Make plot: sporophyte controls
a <-
  dt_control_plot_data %>% 
  filter(generation == "sporophyte") %>%
  ggplot(aes(x = rec_time, y = recovery, shape = dry_time, fill = salt)) +
  geom_point(position = pd, size = 1.5, fill = "white") +
  geom_errorbar(
    aes(ymin = recovery - sd, ymax = recovery + sd), 
    colour = "grey50", width = 0, 
    position = pd) +
  facet_wrap(vars(habit, species)) +
  scale_shape_manual(name = "Desiccation Time",
                     values = c(24, 21),
                     breaks = c("15", "2"),
                     labels = c("15 days", "2 days")) +
  scale_y_continuous(label = label_percent(accuracy = 1)) +
  scale_x_discrete(limits = c("30min","24hr","48hr"),
                   labels = c("0.5", "24", "48")) +
  xlab("Recovery Time (hr)") +
  ylab("Recovery (%)") +
  theme_bw() +
  legend_theme +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank(), 
    panel.grid.major.x = element_blank(),
    strip.text = element_markdown(),
    axis.title.x = element_blank()
  )


# Make plot: gametophyte controls
b <-
  dt_control_plot_data %>% 
  filter(generation == "gametophyte") %>% 
  ggplot(aes(x = rec_time, y = recovery, shape = dry_time, fill = salt)) +
  geom_point(position = pd, size = 1.5, fill = "white") +
  geom_errorbar(
    aes(ymin = recovery - sd, ymax = recovery + sd), 
    colour = "grey50", width = 0, 
    position = pd) +
  facet_wrap(vars(habit, species)) +
  scale_shape_manual(name = "Desiccation Time",
                     values = c(24, 21),
                     breaks = c("15", "2"),
                     labels = c("15 days", "2 days")) +
  scale_y_continuous(label = label_percent(accuracy = 1)) +
  scale_x_discrete(limits = c("30min","24hr","48hr"),
                   labels = c("0.5", "24", "48")) +
  xlab("Recovery Time (hr)") +
  ylab("Recovery (%)") +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(), 
    panel.grid.major.x = element_blank(),
    strip.text = element_markdown()
  ) +
  # Use guides to make the legend go away
  # otherwise it will be duplicated by patchwork
  # https://github.com/thomasp85/patchwork/issues/170#issuecomment-641310103
  guides(shape = "none")

a + b + plot_layout(guides = "collect", ncol = 1, heights = c(85, 15)) + plot_annotation(tag_levels = "a") &
  theme(legend.position='bottom')
```

**`r s_figure("dt-control")`**. Recovery of controls (samples kept on moist tissues) for desiccation tolerance test of filmy fern sporophytes (**a**) and gametophytes (**b**) from Moorea, French Polynesia. Recovery was measured by comparing maximum photochemical yield of photosystem II before desiccation treatment with values at 30 min, 24 hr, and 48 hr following desiccation treatment (see Methods). Recovery was not measured for all combinations of species and desiccation treatments; missing points indicate data not collected (not recovery of 0%). Gametophytes only included a single individual per species thus lack error bars.

\newpage

```{r water-content-desiccated, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Plot relative water content in desiccated state for all species
rel_water_species_means_desic <<-
  rel_water_species_means %>%
  filter(rec_time == "desiccated") %>%
  select(-rec_time)

# Set dodge spacing, colors
pd <- position_dodge(.7)

ggplot(rel_water_species_means_desic, aes(x = rel_water, y = species, group = salt)) +
  geom_errorbar(
    aes(xmin = rel_water - sd, xmax = rel_water + sd),
    color = "grey80",
    width = 0.2,
    position=position_dodge(width=0.5)) +
  geom_point(aes(fill = salt, shape = salt), size = 1.25, position=position_dodge(width=0.5)) +
  scale_x_continuous(label = scales::percent) +
  scale_shape_manual(name = "Desiccation Intensity",
                     values = salt_shapes,
                     breaks = c("NaCl", "MgNO3",  "LiCl", "Control"),
                     labels = c("-38 MPa", "-86 MPa", "-282 Mpa", "Control")) + 
  scale_fill_manual(name = "Desiccation Intensity",
                    values = salt_cols, 
                    breaks = c("NaCl", "MgNO3",  "LiCl", "Control"),
                    labels = c("-38 MPa", "-86 MPa", "-282 Mpa", "Control")) +
  labs(
    x = "Relative Water Content",
    y = "Species",
    color = "Desiccation\nintensity") +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = "bottom"
  ) +
  facet_grid(vars(dry_time), labeller = as_labeller(c(`2` = "2 days", `15` = "15 days")))

# ggsave(here::here("results/S_fig_water_content_desic.pdf"))
```

**`r s_figure("water-all")`**. Relative water content (RWC) of sporophytes after desiccation by duration of desiccation treatment (2 or 15 days). RWC was not measured for all combinations of species and desiccation treatments; missing points indicate data not collected (not RWC of zero).

\newpage

```{r water-content-full, fig.height = 4.5, fig.width = 7, fig.cap = ""}
# Plot only species with weights recorded during recovery
species_with_rec <-
  rel_water_species_means %>%
  filter(rec_time %in% c("30min", "24hr", "48hr")) %>%
  pull(species) %>%
  unique()

rel_water_species_means_with_rec <-
  rel_water_species_means %>%
  filter(species %in% species_with_rec)

pd <- position_dodge(.5)

# Set colors for desiccation intensity
salt_cols <- c(
  "NaCl" = cbPalette[["blue"]], 
  "MgNO3" = cbPalette[["yellow"]], 
  "LiCl" = cbPalette[["red"]], 
  "Control" = "white")

ggplot(rel_water_species_means_with_rec, aes(x = rec_time, y = rel_water, group = interaction(dry_time, salt))) +
  geom_errorbar(
    aes(ymin = rel_water - sd, ymax = rel_water + sd),
    color = "grey50",
    width = 0,
    position = pd) +
  geom_line(position = pd, aes(linetype = dry_time), color = "grey30") +
  geom_point(aes(shape = salt, fill = salt), position = pd) +
  scale_linetype_manual(name = "Desiccation Time",
                        values = c("solid", "dashed"),
                        breaks = c("15", "2"),
                        labels = c("15 days", "2 days")) +
  scale_shape_manual(name = "Desiccation Intensity",
                     values = salt_shapes,
                     breaks = c("NaCl", "MgNO3",  "LiCl", "Control"),
                     labels = c("-38 MPa", "-86 MPa", "-282 Mpa", "Control")) + 
  scale_fill_manual(name = "Desiccation Intensity",
                    values = salt_cols, 
                    breaks = c("NaCl", "MgNO3",  "LiCl", "Control"),
                    labels = c("-38 MPa", "-86 MPa", "-282 Mpa", "Control")) +
  scale_y_continuous(label = scales::percent) +
  facet_wrap(vars(species)) +
  labs(x = "Condition",
       y = "Relative water content") +
  theme_bw() +
  theme(
    panel.grid.major.x = element_blank(),
    legend.position = "bottom",
    legend.box="vertical", 
    legend.margin=margin()
  )

# ggsave(here::here("results/S_fig_water_content_full.png"))
```

**`r s_figure("water-s")`**. Relative water content (RWC) of sporophytes during desiccation tolerance test. RWC was not measured for all combinations of species and desiccation treatments; only species with complete data shown.

\newpage

```{r light-curves, fig.height = 9.5, fig.width = 7, fig.cap = ""}
### Make full sets of light curve plots ###
# - sporos in lab
lc_plots_sporo_lab <- make_facet_lc_plot(
  light_data = light_data_all %>% filter(generation == "sporophyte", condition == "lab"),
  lc_model_fitted_data = filmy_lc_model_fitted_data %>% filter(generation == "sporophyte", condition == "lab"),
  lc_model_params = filmy_lc_model_params %>% filter(generation == "sporophyte", condition == "lab")
)
# - sporos in field
lc_plots_sporo_field <- make_facet_lc_plot(
  light_data = light_data_all %>% filter(generation == "sporophyte", condition == "field"),
  lc_model_fitted_data = filmy_lc_model_fitted_data %>% filter(generation == "sporophyte", condition == "field"),
  lc_model_params = filmy_lc_model_params %>% filter(generation == "sporophyte", condition == "field")
)
# - gametos
lc_plots_gameto <- make_facet_lc_plot(
  light_data = light_data_all %>% filter(generation == "gametophyte"),
  lc_model_fitted_data = filmy_lc_model_fitted_data %>% filter(generation == "gametophyte"),
  lc_model_params = filmy_lc_model_params %>% filter(generation == "gametophyte")
)

### Get the number of pages needed to print each facetted plot ###
n_sporo_lab_lc_pages <- n_pages(lc_plots_sporo_lab)
n_sporo_field_lc_pages <- n_pages(lc_plots_sporo_field)
n_gameto_lc_pages <- n_pages(lc_plots_gameto)

### Print sporos in the lab ###
# first with title "a"
lc_plots_sporo_lab +
  labs(title = "**a**") +
  facet_wrap_paginate(
    vars(str_abbrev_sp_pretty(species), light_id),
    ncol = 4, nrow = 6, page = 1,
    scales = "free", labeller = label_value_2)

# print the rest
# with title "a (cont.)"
for(i in 2:n_sporo_lab_lc_pages) {
  p <- lc_plots_sporo_lab +
    labs(title = "**a** (cont.)") +
    facet_wrap_paginate(
      vars(str_abbrev_sp_pretty(species), light_id),
      ncol = 4, nrow = 6, page = i,
      scales = "free", labeller = label_value_2)
  print(p)
}

### Print the gametos ###
# first with title "b"
lc_plots_gameto +
  labs(title = "**b**") +
  facet_wrap_paginate(
    vars(str_abbrev_sp_pretty(species), light_id),
    ncol = 4, nrow = 6, page = 1,
    scales = "free", labeller = label_value_2)

# print the rest
# with title "b (cont.)"
for(i in 2:n_gameto_lc_pages) {
  p <- lc_plots_gameto +
    labs(title = "**b** (cont.)") +
    facet_wrap_paginate(
      vars(str_abbrev_sp_pretty(species), light_id),
      ncol = 4, nrow = 6, page = i,
      scales = "free", labeller = label_value_2)
  print(p)
}
```

**`r s_figure("light-curves")`**. Rapid light response curves of filmy ferns from Moorea, French Polynesia. **a**, sporophytes; **b**, gametophytes. Title of each subplot indicates species followed by light curve ID number assigned to each sample. Light curves fit using the equation $y = A(1 - e^{-kx})$, where *y* is relative electron transport rate of photosystem II (ETR), *x* is photosynthetic photon flux density (PPFD), *A* is the asymptote of the curve, and *k* is a slope parameter. Outliers at high PPFD not included in the model indicated in light grey. Blue line indicates maximum modeled relative electron transport rate (ETR~max~). Red line indicates PPFD at 95 % saturation of ETR (PPFD~95%~).

\newpage

```{r traits-box, fig.height = 5, fig.width = 7, fig.cap = ""}
combined_species_means_habit <-
  combined_species_means %>%
  left_join(filmy_habit, by = "species") %>%
  mutate(
    habit = case_when(
      habit == "High_Epiphyte" ~ "HE",
      habit == "Low_Epiphyte" ~ "LE",
      habit == "Saxicolous" ~ "S",
      habit == "Terrestrial" ~ "T"
    ) %>% factor(., levels = c("HE", "LE", "S", "T"))
  ) 

generation_colors <- c(
  "gametophyte" = cbPalette[["skyblue"]],
  "sporophyte" = cbPalette[["red"]]
)

plot_sp_mean <- function(data, var_name, var_label) {
  
  ggplot(data, 
         aes(x = habit, y = {{var_name}}, fill = generation)) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.2)) +
    scale_fill_manual(values = generation_colors, labels = str_to_sentence) +
    labs(
      y = var_label,
      x = "Growth Habit",
      fill = "Generation"
    )
  
}

a <- plot_sp_mean(combined_species_means_habit, etr_mean, "ETR<sub>max<sub>") +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_markdown())

b <- plot_sp_mean(combined_species_means_habit, par_mean, "PPFD<sub>95%<sub>") +
  theme(axis.title.y = element_markdown())

c <- plot_sp_mean(combined_species_means_habit, recovery_mean, "Recovery") +
  scale_y_continuous(labels = percent)

a + b + c + guide_area() + plot_layout(ncol = 2, guides = 'collect') + plot_annotation(tag_levels = "a")
```

**`r s_figure("traits-box")`**. Box plots comparing physiological parameters between sporophytes (red) and gametophytes (blue) across growth habits in filmy ferns from Moorea, French Polynesia. Each point represents one species; dark line is median, lower and upper edges correspond to first and third quartiles, and whiskers extend to the most extreme value no further than 1.5 times the inter-quartile range. **a**, ETR~max~ (µmol electrons m^--2^ ·s^--1^); **b** PPFD~95%~ (µmol photons m^--2^ ·s^--1^); **c**, recovery (%) of chlorophyll fluorescence (F~v~/F~m~) following 2 day desiccation at –86 MPa (*Abrodictyum dentatum* was desiccated at –38 MPa instead of –86 MPa). *Crepidomanes bipunctatum* and *C. humile* were observed growing as both epiphytes and saxicoles, but are treated as epiphytes to distinguish them from exclusively saxicolous species.

\newpage

```{r capi-water, fig.height = 4, fig.width = 4, fig.cap = ""}
# Calculate recovery from 100% RH treatment for Callistopteris apiifolia gametophytes
cal_water_recovery <- filmy_dt %>%
  # Only include samples that should be presented in the main MS
  filter(salt == "H2O", species == "Callistopteris_apiifolia") %>%
  # Filter out individuals with low pre-treatment yields
  filter(!is.na(yield_pre), yield_pre > 400) %>%
  calculate_recovery() %>%
  calculate_mean_recovery() %>%
  rename(recovery = recovery_mean, sd = recovery_sd) %>%
  verify(length(unique(recovery_n)) == 1)

cal_water_n <- cal_water_recovery$recovery_n %>% unique()

# Plot recovery
ggplot(cal_water_recovery, aes(x = rec_time, y = recovery, group = interaction(dry_time, salt))) +
  geom_line() +
  geom_errorbar(
    aes(ymin = recovery - sd, ymax = recovery + sd), 
    colour = "grey50", width = 0.1) +
  geom_point(size = 1.5) +
  scale_y_continuous(label = label_percent(accuracy = 1), limits = c(-0.1,1.2), expand = c(0,0), breaks=c(0,.25,.5,.75,1.0)) +
  scale_x_discrete(limits = c("30min","24hr","48hr"),
                   labels = c("0.5", "24", "48")) +
  labs(
    x = "Recovery Time (hr)",
    y = "Recovery"
  )
```

**`r s_figure("capi-water")`**. Recovery of *Callistopteris apiifolia* gametophytes from Moorea, French Polynesia from desiccation treatment at 100 % RH (water used in place of desiccation salt). *n* = `r cal_water_n`.
